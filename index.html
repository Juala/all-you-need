<?php
// ================= KONFIGURASI =================
$API_KEY = "b946c6d83873d1c4ab5906554ea45d39"; // API Key kamu
$API_URL = "https://premiumku.store/api/";
$WA_ADMIN = "6282262642007"; // Ganti nomor WA Admin kamu

// ================= LOGIC API (SERVER SIDE) =================
if (isset($_GET['action'])) {
    header('Content-Type: application/json');
    
    function callPremiumku($endpoint, $postData) {
        $ch = curl_init($endpoint);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($postData));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        $response = curl_exec($ch);
        curl_close($ch);
        return $response;
    }

    if ($_GET['action'] == 'get_products') {
        echo callPremiumku($API_URL . "products", ["api_key" => $API_KEY]);
    } 
    elseif ($_GET['action'] == 'get_stock') {
        $id = $_GET['id'] ?? 0;
        echo callPremiumku($API_URL . "stock", ["api_key" => $API_KEY, "product_id" => (int)$id]);
    } 
    elseif ($_GET['action'] == 'create_order') {
        $json = file_get_contents('php://input');
        $data = json_decode($json, true);
        $data['api_key'] = $API_KEY;
        echo callPremiumku($API_URL . "order", $data);
    }
    exit;
}
?>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order RojaServer</title>
    <style>
        body{font-family:'Segoe UI', Tahoma, sans-serif; background:#f4f7f6; padding:20px; margin:0;}
        .container{max-width:450px; margin:auto; background:#fff; padding:25px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.1);}
        h2{text-align:center; color:#333; margin-bottom:20px;}
        label{font-weight:bold; display:block; margin-top:15px; color:#555;}
        select, input{width:100%; padding:12px; margin-top:5px; border-radius:8px; border:1px solid #ddd; box-sizing: border-box;}
        button{margin-top:20px; width:100%; padding:14px; border:none; border-radius:8px; background:#000; color:#fff; font-size:16px; font-weight:bold; cursor:pointer; transition: 0.3s;}
        button:hover{background:#333;}
        .btn-wa{background:#25d366;}
        .btn-wa:hover{background:#128c7e;}
        .hidden{display:none;}
        .price-box{margin-top:15px; padding:10px; background:#e8f5e9; border-radius:8px; font-size:18px; font-weight:bold; color:#2e7d32; text-align:center;}
        .info-stok{font-size:13px; color:#666; margin-top:5px;}
        #result{margin-top:15px; padding:10px; border-radius:8px;}
    </style>
</head>
<body>

<div class="container">
    <h2>RojaServer Order</h2>

    <label>Pilih Metode Order:</label>
    <select id="metodeOrder" onchange="switchMode()">
        <option value="biasa">Order Biasa (WhatsApp)</option>
        <option value="fast" selected>Order FAST (Otomatis API)</option>
    </select>

    <div id="normalBox" class="hidden">
        <label>Pilih Layanan:</label>
        <select id="productNormal">
            <option value="Followers Instagram">Followers Instagram</option>
            <option value="Followers TikTok">Followers TikTok</option>
            <option value="App Premium">App Premium</option>
        </select>
        <label>Target (Username/Link):</label>
        <input type="text" id="targetNormal" placeholder="Contoh: @username">
        <button class="btn-wa" onclick="orderBiasa()">ORDER VIA WHATSAPP</button>
    </div>

    <div id="fastBox">
        <label>Produk FAST:</label>
        <select id="fastProduct" onchange="cekStok()">
            <option value="">Memuat produk...</option>
        </select>
        <div id="stokText" class="info-stok"></div>

        <label>Jumlah:</label>
        <input type="number" id="fastQty" value="1" min="1">

        <label>WhatsApp Target:</label>
        <input type="text" id="fastWa" placeholder="628xxxxxx">

        <button onclick="prosesOrderFast()">BUAT ORDER FAST</button>
    </div>

    <div id="result"></div>
</div>

<script>
// Jalankan saat pertama kali dibuka
window.onload = muatProduk;

function switchMode() {
    const mode = document.getElementById('metodeOrder').value;
    document.getElementById('normalBox').classList.toggle('hidden', mode !== 'biasa');
    document.getElementById('fastBox').classList.toggle('hidden', mode === 'biasa');
    if(mode === 'fast') muatProduk();
}

async function muatProduk() {
    try {
        const res = await fetch('?action=get_products');
        const data = await res.json();
        const select = document.getElementById('fastProduct');
        select.innerHTML = '<option value="">-- Pilih Produk --</option>';
        data.products.forEach(p => {
            if(p.status === 'available') {
                select.innerHTML += `<option value="${p.id}">${p.name} - Rp ${p.price.toLocaleString()}</option>`;
            }
        });
    } catch (e) { console.error("Gagal muat produk"); }
}

async function cekStok() {
    const id = document.getElementById('fastProduct').value;
    if(!id) return;
    const res = await fetch('?action=get_stock&id=' + id);
    const data = await res.json();
    document.getElementById('stokText').innerHTML = `Stok tersedia: <b>${data.stock}</b>`;
}

function orderBiasa() {
    const p = document.getElementById('productNormal').value;
    const t = document.getElementById('targetNormal').value;
    const msg = `Halo Admin, saya mau order:\nProduk: ${p}\nTarget: ${t}`;
    window.open(`https://wa.me/<?php echo $WA_ADMIN; ?>?text=${encodeURIComponent(msg)}`);
}

async function prosesOrderFast() {
    const resDiv = document.getElementById('result');
    resDiv.innerHTML = "âŒ› Sedang memproses...";
    resDiv.style.background = "#fff3cd";

    const payload = {
        product_id: parseInt(document.getElementById('fastProduct').value),
        qty: parseInt(document.getElementById('fastQty').value),
        whatsapp: document.getElementById('fastWa').value
    };

    try {
        const res = await fetch('?action=create_order', {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        const result = await res.json();

        if(result.success) {
            resDiv.style.background = "#d4edda";
            resDiv.style.color = "#155724";
            resDiv.innerHTML = `<b>BERHASIL!</b><br>Invoice: ${result.invoice}<br>Total: Rp ${result.total.toLocaleString()}`;
        } else {
            resDiv.style.background = "#f8d7da";
            resDiv.style.color = "#721c24";
            resDiv.innerHTML = `<b>GAGAL:</b> ${result.message}`;
        }
    } catch (e) { 
        resDiv.innerHTML = "Terjadi kesalahan koneksi ke server."; 
    }
}
</script>
</body>
</html>
