<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>ROJA ADMIN - Data Pesanan</title>
<style>
body{font-family:Arial, sans-serif;background:#f0f0f0;padding:20px;margin:0;}
.container{max-width:1100px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #ccc;padding:10px;text-align:center;font-size:14px;vertical-align:middle;}
th{background:#333;color:#fff;}
input, textarea, select{width:100%;padding:10px;margin-top:10px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;}
.small-btn{padding:6px 8px;font-size:13px;border-radius:6px}
.success{background:#28a745;color:#fff}
.warn{background:#ff9800;color:#fff}
.danger{background:#e91e63;color:#fff}
.copy-btn{background:#2196F3;color:#fff}
.flex{display:flex;gap:8px;align-items:center}
.note{font-size:13px;color:#555;margin-top:6px}
.pre{font-family:monospace;background:#f8f8f8;padding:8px;border-radius:6px;border:1px solid #eee}

/* Keep multi-select visually compact so it doesn't disrupt layout */
#produkKupon {height: auto; min-height: 44px; max-height: 160px;}
.badge-fast {background:#ffecb3;color:#8a6d00;padding:4px 8px;border-radius:6px;font-weight:600;}
.fastcode-box {display:flex;gap:8px;align-items:center;justify-content:center}
</style>
</head>
<body>

<div class="container">
<h2>ðŸ“¦ Data Pesanan Masuk (ROJA ADMIN)</h2>

<input type="text" id="search" placeholder="Cari berdasarkan ROJAID-XXXXX" style="padding:10px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box;">

<!-- FITUR TAMBAH KUPON -->
<h3 style="margin-top:20px;">ðŸŽŸ Tambah Kupon Diskon</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
  <input type="text" id="kodeKupon" placeholder="Kode Kupon (ex: DISKON10)">
  <input type="number" id="nilaiKupon" placeholder="Nilai Potongan (ex: 10000)">
</div>
<!-- tambahan: pilih produk untuk kupon (multi) -->
<label style="margin-top:8px;font-size:13px;color:#333">Pilih Produk yang mendapat potongan (Ctrl/Cmd+klik untuk pilih banyak) :</label>
<select id="produkKupon" multiple size="4" title="Ctrl/Cmd+klik untuk pilih beberapa produk"></select>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;">
  <input type="date" id="masaKupon">
  <input type="number" id="limitKupon" placeholder="Limit pemakaian (0 = unlimited)">
</div>
<button style="background:#008000;color:white;margin-top:10px;" onclick="buatKupon()">Tambah Kupon</button>

<!-- TABEL PESANAN -->
<h3 style="margin-top:25px;">ðŸ“¦ Tabel Pesanan</h3>
<table>
<thead>
<tr>
<th>ID Pesanan</th>
<th>Nama / Username</th>
<th>WA</th>
<th>Produk</th>
<th>Total</th>
<th>FAST?</th>
<th>FAST CODE</th>
<th>Status</th>
<th>Aksi</th>
<th>Nota</th>
</tr>
</thead>
<tbody id="orderTable"></tbody>
</table>

<!-- TABEL KUPON -->
<h3 style="margin-top:25px;">ðŸ“‘ Daftar Kupon Aktif</h3>
<table>
<thead>
<tr>
<th>Kode</th>
<th>Potongan</th>
<th>Produk</th>
<th>Expired</th>
<th>Limit</th>
<th>Used</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="kuponBody"></tbody>
</table>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, update, remove, set, get, child, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDpj7udfBLEqlloEqidlSJYHt-2icTOGCw",
  authDomain: "database-jualan.firebaseapp.com",
  databaseURL: "https://database-jualan-default-rtdb.firebaseio.com",
  projectId: "database-jualan",
  storageBucket: "database-jualan.appspot.com",
  messagingSenderId: "766732892106",
  appId: "1:766732892106:web:cd223204bfbb529599c133"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const table = document.getElementById("orderTable");
const search = document.getElementById("search");
const kuponBody = document.getElementById("kuponBody");
const produkKuponSelect = document.getElementById("produkKupon");

let dataOrders = [];

// LOAD PESANAN: listen node "orders"
onValue(ref(db, "orders"), (snapshot)=>{
    table.innerHTML = "";
    dataOrders = [];

    snapshot.forEach(child=>{
        dataOrders.push({
          key: child.key,
          ...child.val()
        });
    });

    renderTable(dataOrders);
});

// Helper: check apakah order termasuk Fast
function isFastOrder(data){
  // jika ada fastProductId simpan oleh sistem fast order, atau nama produk mengandung "fast"
  try {
    if(data.fastProductId) return true;
    const prod = (data.product || "").toString().toLowerCase();
    if(prod.includes("fast")) return true;
  } catch(e){}
  return false;
}

function renderTable(list){
  table.innerHTML = "";
  list.forEach(data=>{
    const nama = data.username ?? data.fullname ?? "-";
    const akunShort = "-"; // fitur kirim akun dihapus
    const fastFlag = isFastOrder(data);
    const fastBadge = fastFlag ? `<span class="badge-fast">FAST</span>` : "";
    const fastCodeValue = data.fastcode ? data.fastcode : "";

    // fastcode cell: tampilkan fastCode & tombol salin jika ada
    let fastCodeCell = "-";
    if(fastFlag){
      fastCodeCell = `<div class="fastcode-box"> 
        <span style="max-width:160px;word-break:break-word">${fastCodeValue || "<i>Belum diisi</i>"}</span>
        ${fastCodeValue ? `<button class="small-btn copy-btn" onclick="salinFastCode('${data.key}')">Salin</button>` : ""}
      </div>`;
    }

    table.innerHTML += `
    <tr>
        <td>${data.orderId ?? ""}</td>
        <td style="max-width:160px;word-break:break-word">${nama}</td>
        <td>${data.phone ?? ""}</td>
        <td style="max-width:220px;word-break:break-word">${data.product ?? "-"}</td>
        <td>Rp ${Number(data.harga ?? 0).toLocaleString("id-ID")}</td>
        <td>${fastBadge}</td>
        <td>${fastCodeCell}</td>
        <td>
          <select onchange="handleStatusChange('${data.key}', this.value)">
            <option ${data.status=="Pending"?"selected":""}>Pending</option>
            <option ${data.status=="Proses"?"selected":""}>Proses</option>
            <option ${data.status=="Success"?"selected":""}>Success</option>
            <option ${data.status=="Cancel"?"selected":""}>Cancel</option>
          </select>
        </td>
        <td style="min-width:140px;">
          <div class="flex" style="justify-content:center">
            <button onclick="deleteOrder('${data.key}')" class="small-btn danger">Hapus</button>
            <button onclick="lihatDetail('${data.key}')" class="small-btn" style="background:#6c757d;color:white">Detail</button>
          </div>
        </td>
        <td><a href="nota.html?id=${encodeURIComponent(data.orderId ?? '')}" target="_blank" class="small-btn" style="background:#008CBA;color:white;">Lihat Nota</a></td>
    </tr>`;
  });
}

// Search filter
search.addEventListener("keyup", ()=>{
  const keyword = (search.value||"").toUpperCase();
  const filtered = dataOrders.filter(item=> (item.orderId||"").toUpperCase().includes(keyword) );
  renderTable(filtered);
});

// HAPUS ORDER
window.deleteOrder = function(key){
  if(confirm("Yakin ingin menghapus pesanan ini?")){
    remove(ref(db, "orders/" + key));
  }
}

// LIHAT DETAIL sederhana
window.lihatDetail = async function(key){
  const snap = await get(child(ref(db), "orders/" + key));
  if(!snap.exists()) return alert("Data tidak ditemukan");
  const d = snap.val();
  let txt = `Order ID: ${d.orderId || ""}\nProduk: ${d.product || ""}\nNama/Username: ${d.username || d.fullname || "-"}\nWA: ${d.phone || "-"}\nTotal: Rp ${Number(d.harga || 0).toLocaleString("id-ID")}\nStatus: ${d.status || "-"}\n\n`;
  if(isFastOrder(d)){
    txt += `FAST: Ya\nFastProductId: ${d.fastProductId || "-"}\nFastCode: ${d.fastcode || "-"}\n`;
  }
  alert(txt);
}

// SALIN FAST CODE
window.salinFastCode = async function(key){
  const snap = await get(child(ref(db), "orders/" + key));
  if(!snap.exists()) return alert("Data tidak ditemukan");
  const d = snap.val();
  const code = d.fastcode || "";
  if(!code) return alert("Belum ada Fast Code untuk pesanan ini.");
  navigator.clipboard.writeText(code).then(()=> alert("Fast Code berhasil disalin ke clipboard"));
}

// HANDLE STATUS CHANGE
window.handleStatusChange = async function(key, newStatus){
  // ambil data order
  const snap = await get(child(ref(db), "orders/" + key));
  if(!snap.exists()) return alert("Data tidak ditemukan.");
  const d = snap.val();

  const fastFlag = isFastOrder(d);

  // Jika status diubah menjadi Success dan order adalah Fast -> minta kode fast
  if(newStatus === "Success" && fastFlag){
    let kode = prompt("Masukkan Fast Code untuk pesanan ini (kosongkan jika tidak ada):");
    if(kode === null){
      // user cancel -> kembali ke status sebelumnya (refresh select)
      renderTable(dataOrders);
      return;
    }
    kode = kode.trim();
    const payload = { status: newStatus, fastcode: kode || "" , updateTime: new Date().toLocaleString("id-ID", { timeZone: "Asia/Jakarta" }) };
    try {
      await update(ref(db, "orders/" + key), payload);
      alert("Status diupdate dan Fast Code disimpan.");
    } catch(err){
      console.error(err);
      alert("Gagal menyimpan Fast Code: " + err.message);
    }
    return;
  }

  // Jika status menjadi Success tapi bukan Fast -> update status standard
  try {
    await update(ref(db, "orders/" + key), { status: newStatus, updateTime: new Date().toLocaleString("id-ID", { timeZone: "Asia/Jakarta" }) });
  } catch(err){
    console.error(err);
    alert("Gagal update status: " + err.message);
  }
}

// --- FUNGSI KUPON ---
window.buatKupon = function(){
  const kode = document.getElementById("kodeKupon").value.trim().toUpperCase();
  const value = Number(document.getElementById("nilaiKupon").value);
  const expires = document.getElementById("masaKupon").value;
  const limit = Number(document.getElementById("limitKupon").value);

  if(!kode || !value) return alert("Isi kode & nilai kupon.");

  // ambil pilihan produk (multi)
  const produkSelected = Array.from(produkKuponSelect.options)
    .filter(opt => opt.selected)
    .map(opt => opt.value)
    .filter(v => v && v !== ""); // filter kosong

  // jika tidak memilih produk, anggap berlaku untuk semua produk
  const productsToSave = (produkSelected.length === 0) ? ["ALL"] : produkSelected;

  set(ref(db, "coupons/" + kode), {
    value,
    expires: expires || "",
    limit: limit || 0,
    used: 0,
    products: productsToSave
  }).then(()=> { 
    alert("Kupon berhasil ditambahkan!");
    // reset fields (optional)
    document.getElementById("kodeKupon").value = "";
    document.getElementById("nilaiKupon").value = "";
    document.getElementById("masaKupon").value = "";
    document.getElementById("limitKupon").value = "";
    // clear selection
    Array.from(produkKuponSelect.options).forEach(o => o.selected = false);
  }).catch(err=>{
    console.error(err);
    alert("Gagal membuat kupon: " + err.message);
  });
};

// LIST & HAPUS KUPON
onValue(ref(db, "coupons"), (snapshot)=>{
  kuponBody.innerHTML="";
  snapshot.forEach(child=>{
    const kode = child.key;
    const data = child.val();

    // format produk untuk tampilan
    let produkDisplay = "-";
    if(Array.isArray(data.products)){
      if(data.products.includes("ALL")) produkDisplay = "Semua Produk";
      else produkDisplay = data.products.join(", ");
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${kode}</td>
      <td>Rp ${Number(data.value).toLocaleString()}</td>
      <td style="max-width:260px;word-break:break-word">${produkDisplay}</td>
      <td>${data.expires || "Selamanya"}</td>
      <td>${data.limit == 0 ? "Unlimited" : data.limit}</td>
      <td>${data.used ?? 0}</td>
      <td><button onclick="hapusKupon('${kode}')" class="small-btn danger">Hapus</button></td>
    `;
    kuponBody.appendChild(tr);
  });
});

window.hapusKupon = function(kode){
  if(confirm("Yakin ingin menghapus kupon "+ kode +"?")){
    remove(ref(db, "coupons/" + kode));
  }
};

/* LOAD PRODUCTS TO SELECT (ambil dari node 'products' jika ada, fallback ke daftar umum) */
async function loadProducts(){
  const prodRef = ref(db, "products");
  try {
    const snap = await get(prodRef);
    let products = [];

    if(snap.exists()){
      const val = snap.val();
      if(Array.isArray(val)){
        products = val.map((v,i)=>({ id: v.id ?? ("p"+i), name: v.name ?? v.nama ?? v.title ?? JSON.stringify(v) }));
      } else {
        products = Object.keys(val).map(k => ({ id: k, name: val[k].name ?? val[k].nama ?? k }));
      }
    } else {
      products = [
        { id: "followers_ig", name: "Followers Instagram Indonesia" },
        { id: "followers_tt", name: "Followers TikTok Indonesia" },
        { id: "likes_ig", name: "Like Instagram Indonesia" },
        { id: "likes_tt", name: "Like TikTok Indonesia" },
        { id: "app_prem", name: "App Premium" }
      ];
    }

    // clear current
    produkKuponSelect.innerHTML = "";
    // add helper option for ALL
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "Semua Produk (Pilih jika berlaku ke semua)";
    produkKuponSelect.appendChild(optAll);

    products.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      produkKuponSelect.appendChild(opt);
    });
  } catch(err){
    console.error("Gagal load products:", err);
    produkKuponSelect.innerHTML = `
      <option value="ALL">Semua Produk (Pilih jika berlaku ke semua)</option>
      <option value="followers_ig">Followers Instagram Indonesia</option>
      <option value="followers_tt">Followers TikTok Indonesia</option>
      <option value="likes_ig">Like Instagram Indonesia</option>
      <option value="likes_tt">Like TikTok Indonesia</option>
      <option value="app_prem">App Premium</option>
    `;
  }
}

/* Inisialisasi saat load */
window.addEventListener("load", ()=>{
  loadProducts();
});
</script>
</body>
  </html>
  
